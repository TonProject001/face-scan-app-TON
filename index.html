<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Face SICU (Pro)</title>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) */
    * { box-sizing: border-box; }
    body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; background: #000; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    #home-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: transform 0.3s ease-in-out; }
    .logo-area { margin-bottom: 50px; text-align: center; }
    .logo-icon { font-size: 80px; margin-bottom: 10px; }
    .app-title { font-size: 24px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .app-subtitle { font-size: 16px; opacity: 0.8; }
    .menu-btn { width: 80%; max-width: 300px; padding: 18px; margin: 10px 0; font-size: 18px; font-weight: 500; font-family: 'Prompt', sans-serif; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .menu-btn:active { transform: scale(0.95); }
    .btn-checkin { background: #fff; color: #1e3c72; font-weight: bold; }
    .btn-register { background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.5); }
    #camera-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; z-index: 50; }
    #video-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .top-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 60; }
    .close-btn { background: rgba(0,0,0,0.3); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .bottom-controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 120px; display: flex; justify-content: center; align-items: center; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); z-index: 60; }
    #shutter-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); border: 4px solid white; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; }
    #shutter-btn .inner-circle { width: 65px; height: 65px; background: white; border-radius: 50%; transition: all 0.2s; }
    #shutter-btn:active .inner-circle { width: 55px; height: 55px; background: #ddd; }
    #shutter-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #shutter-btn.reg-mode { border-color: #007bff; }
    #shutter-btn.reg-mode .inner-circle { background: #007bff; }
    #shutter-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 100; }
    .flash-anim { animation: flash 0.2s ease-out; }
    @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }
    #countdown-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 150px; font-weight: bold; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none; z-index: 80; }
    
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Visual Feedback ‡πÄ‡∏ß‡∏•‡∏≤ AI ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à */
    #match-confidence-bar {
      position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%);
      width: 200px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px;
      overflow: hidden; display: none; z-index: 70;
    }
    #match-confidence-fill {
      width: 0%; height: 100%; background: #00ff00; transition: width 0.2s;
    }
  </style>
</head>
<body>

  <div id="home-screen">
    <div class="logo-area">
      <div class="logo-icon">üì∏</div>
      <div class="app-title">Face SICU Pro</div>
      <div class="app-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á</div>
    </div>
    <button class="menu-btn btn-checkin" onclick="openCamera('scan')"><span>üïí</span> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
    <button class="menu-btn btn-register" onclick="openCamera('register')"><span>üë§</span> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    <div style="margin-top:30px; font-size: 12px; opacity: 0.5;">v.3.0 High Accuracy</div>
  </div>

  <div id="camera-screen">
    <div class="top-bar">
      <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
      <button class="close-btn" onclick="closeCamera()">‚úï</button>
    </div>
    <div id="video-wrapper">
      <video id="video" autoplay muted playsinline></video>
      <div id="countdown-overlay">3</div>
      <div id="shutter-flash"></div>
      
      <div id="match-confidence-bar"><div id="match-confidence-fill"></div></div>
    </div>
    <div class="bottom-controls">
      <div id="shutter-btn" onclick="handleShutter()">
        <div class="inner-circle"></div>
      </div>
    </div>
  </div>

  <script>
    // ******************************************************
    // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á APPS SCRIPT ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // ******************************************************
    const GAS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpYV4iyfDavR6S2xrfUfWpQdlao-4GXtMSNRzcrXT69p6rdzP92NWWWMf7oqM2-kx-jw/exec'; 

    let currentMode = 'scan';
    let isCameraRunning = false;
    let detectionInterval;
    let labeledFaceDescriptors = [];
    let currentBestMatch = null;
    let currentStream = null;

    // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Logic ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ---
    let consistentMatchCount = 0; // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
    let lastMatchedLabel = null;
    const REQUIRED_CONSISTENT_FRAMES = 5; // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ú‡∏¥‡∏î)
    const STRICT_THRESHOLD = 0.4; // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î 0.4 ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡∏°‡∏≤‡∏Å)

    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    const homeScreen = document.getElementById('home-screen');
    const cameraScreen = document.getElementById('camera-screen');
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const shutterBtn = document.getElementById('shutter-btn');
    const countdownEl = document.getElementById('countdown-overlay');
    const shutterFlash = document.getElementById('shutter-flash');
    const confidenceBar = document.getElementById('match-confidence-bar');
    const confidenceFill = document.getElementById('match-confidence-fill');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- Core Functions ---

    async function openCamera(mode) {
      currentMode = mode;
      homeScreen.style.display = 'none';
      cameraScreen.style.display = 'block';
      
      // Reset logic variables
      consistentMatchCount = 0;
      lastMatchedLabel = null;
      confidenceBar.style.display = 'none';

      if (mode === 'register') {
        shutterBtn.classList.add('reg-mode');
        statusEl.innerText = "‡πÇ‡∏´‡∏°‡∏î: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (High Accuracy)";
      } else {
        shutterBtn.classList.remove('reg-mode');
        statusEl.innerText = "‡πÇ‡∏´‡∏°‡∏î: ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤...)";
      }

      await initCameraSystem();
    }

    function closeCamera() {
      stopStream();
      if (detectionInterval) clearInterval(detectionInterval);
      homeScreen.style.display = 'flex';
      cameraScreen.style.display = 'none';
      isCameraRunning = false;
      const canvas = document.querySelector('canvas');
      if (canvas) canvas.remove();
    }

    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      if (video.srcObject) video.srcObject = null;
    }

    async function initCameraSystem() {
      if(isCameraRunning) return;
      isCameraRunning = true;

      try {
        statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≠‡∏á AI (SSD MobileNet)...";
        
        // --- CHANGE 1: ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏• SSD MobileNet V1 ‡πÅ‡∏ó‡∏ô TinyFace (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢) ---
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (!faceapi.nets.ssdMobilenetv1.params) {
             await Promise.all([
              // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å tinyFaceDetector ‡πÄ‡∏õ‡πá‡∏ô ssdMobilenetv1
              faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
              faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
              faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
        }

        if (labeledFaceDescriptors.length === 0) {
            statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            const data = await callBackend({ action: 'load_faces' });
            if (data.status === 'success' && data.faces.length > 0) {
                labeledFaceDescriptors = data.faces.map(f => {
                  const descriptorFloat32 = new Float32Array(Object.values(f.descriptor));
                  return new faceapi.LabeledFaceDescriptors(f.label, [descriptorFloat32]);
                });
            }
        }

        statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
        await startCameraSafe();

      } catch (err) {
        statusEl.innerText = "Error: " + err.message;
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        closeCamera();
      }
    }

    async function startCameraSafe() {
      stopStream();
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î HD
      const constraintsHD = { video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } };
      const constraintsBasic = { video: { facingMode: 'user' } };

      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraintsHD);
      } catch (e) {
        try {
          currentStream = await navigator.mediaDevices.getUserMedia(constraintsBasic);
        } catch (e2) {
          throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
        }
      }

      video.srcObject = currentStream;
      video.onloadedmetadata = () => { video.play(); };
    }

    video.addEventListener('play', () => {
      const oldCanvas = document.querySelector('canvas'); if (oldCanvas) oldCanvas.remove();
      const canvas = faceapi.createCanvasFromMedia(video);
      document.getElementById('video-wrapper').append(canvas);
      
      const displaySize = { width: video.videoWidth, height: video.videoHeight };
      faceapi.matchDimensions(canvas, displaySize);

      statusEl.innerText = currentMode === 'scan' ? "‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á..." : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
      if (detectionInterval) clearInterval(detectionInterval);

      // --- Loop AI ---
      detectionInterval = setInterval(async () => {
        if (cameraScreen.style.display === 'none' || video.paused || video.ended) return;

        // --- CHANGE 2: ‡πÉ‡∏ä‡πâ SsdMobilenetv1Options (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á) ---
        // minConfidence: 0.5 ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏±‡∏ö
        const options = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 });
        
        const detections = await faceapi.detectAllFaces(video, options)
          .withFaceLandmarks().withFaceDescriptors();
        
        if (detections.length > 0) {
          detections.sort((a, b) => (b.detection.box.width * b.detection.box.height) - (a.detection.box.width * a.detection.box.height));
          const largestFace = detections[0];

          if (labeledFaceDescriptors.length > 0) {
            // --- CHANGE 3: ‡πÉ‡∏ä‡πâ Threshold ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡∏°‡∏≤‡∏Å (0.4) ---
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, STRICT_THRESHOLD);
            const match = faceMatcher.findBestMatch(largestFace.descriptor);
            
            // --- CHANGE 4: Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (Consistency Check) ---
            if (match.label !== 'unknown') {
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ü‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏ü‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
              if (match.label === lastMatchedLabel) {
                consistentMatchCount++;
              } else {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                consistentMatchCount = 1;
                lastMatchedLabel = match.label;
              }

              // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (Visual Feedback)
              confidenceBar.style.display = 'block';
              let progress = (consistentMatchCount / REQUIRED_CONSISTENT_FRAMES) * 100;
              if (progress > 100) progress = 100;
              confidenceFill.style.width = progress + '%';

              // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á
              if (consistentMatchCount >= REQUIRED_CONSISTENT_FRAMES) {
                currentBestMatch = match;
                if(currentMode === 'scan') {
                    statusEl.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô: " + match.label;
                    statusEl.style.color = "#00ff00"; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                }
              } else {
                statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö... (" + consistentMatchCount + "/" + REQUIRED_CONSISTENT_FRAMES + ")";
                statusEl.style.color = "white";
                currentBestMatch = null; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ü‡∏±‡∏ô‡∏ò‡∏á
              }
            
            } else {
              // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å (Unknown)
              consistentMatchCount = 0;
              lastMatchedLabel = null;
              currentBestMatch = null;
              confidenceBar.style.display = 'none';
              if(currentMode === 'scan') {
                  statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                  statusEl.style.color = "red";
              }
            }
          }
        } else {
          // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏¢
          consistentMatchCount = 0;
          currentBestMatch = null;
          confidenceBar.style.display = 'none';
          if(currentMode === 'scan') {
              statusEl.innerText = "‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
              statusEl.style.color = "white";
          }
        }
      }, 200); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 200ms
    });

    function handleShutter() {
      if (currentMode === 'scan') {
        startCountdownAndCapture();
      } else {
        registerProcess();
      }
    }

    function startCountdownAndCapture() {
      if (labeledFaceDescriptors.length === 0) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤"); return; }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô: ‡∏ñ‡πâ‡∏≤ AI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Confirm ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢
      if (!currentBestMatch && currentMode === 'scan') {
          alert("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ ‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
          return;
      }

      shutterBtn.style.pointerEvents = 'none'; 
      let count = 3;
      countdownEl.style.display = 'block';
      countdownEl.innerText = count;

      const timer = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.innerText = count;
        } else {
          clearInterval(timer);
          countdownEl.style.display = 'none';
          captureScan(); 
        }
      }, 1000);
    }

    function captureScan() {
      if (!currentBestMatch || currentBestMatch.label === 'unknown') {
        statusEl.innerText = "‚ùå ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
        playBeep(); playBeep();
        shutterBtn.style.pointerEvents = 'auto';
        return;
      }

      playBeep();
      triggerFlash();
      statusEl.innerText = "üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + currentBestMatch.label;
      statusEl.style.color = "white";

      const imageBase64 = getResizedFrame();

      callBackend({
        action: 'save_scan',
        name: currentBestMatch.label,
        image: imageBase64
      }).then(res => {
        statusEl.innerText = "‚úÖ " + res.message;
        setTimeout(() => { statusEl.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠..."; shutterBtn.style.pointerEvents = 'auto'; }, 2000);
      }).catch(err => {
         statusEl.innerText = "‚ùå Error ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
         shutterBtn.style.pointerEvents = 'auto';
      });
    }

    async function registerProcess() {
      const name = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:");
      if (!name) return;

      statusEl.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á...";
      try {
        // ‡πÉ‡∏ä‡πâ SSD MobileNet ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Reference ‡∏ä‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
            .withFaceLandmarks().withFaceDescriptor();
        
        if (detection) {
          playBeep();
          triggerFlash();
          
          labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
          
          statusEl.innerText = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
          await callBackend({
            action: 'save_face',
            name: name,
            descriptor: Array.from(detection.descriptor)
          });
          
          alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + name);
          statusEl.innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        } else {
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô");
          statusEl.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
        }
      } catch (e) {
        alert("Error: " + e);
      }
    }

    function triggerFlash() {
      shutterFlash.classList.add('flash-anim');
      setTimeout(() => shutterFlash.classList.remove('flash-anim'), 500);
    }

    function playBeep() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'sine'; osc.frequency.value = 880; gain.gain.value = 0.1;
      osc.start(); setTimeout(() => osc.stop(), 150);
    }

    function getResizedFrame() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth; 
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      
      ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
      const now = new Date();
      const dateText = now.toLocaleDateString('th-TH') + " " + now.toLocaleTimeString('th-TH');
      ctx.font = "20px Prompt"; ctx.fillStyle = "white"; 
      ctx.shadowColor="black"; ctx.shadowBlur=4;
      ctx.fillText(dateText, 10, canvas.height - 20);

      return canvas.toDataURL('image/jpeg', 0.8);
    }

    async function callBackend(payload) {
      const response = await fetch(GAS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      return await response.json();
    }
  </script>
</body>
</html>
