<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Face SICU</title>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* ... (‡πÉ‡∏ä‡πâ CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) ... */
    * { box-sizing: border-box; }
    body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; background: #000; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    #home-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: transform 0.3s ease-in-out; }
    .logo-area { margin-bottom: 50px; text-align: center; }
    .logo-icon { font-size: 80px; margin-bottom: 10px; }
    .app-title { font-size: 24px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .app-subtitle { font-size: 16px; opacity: 0.8; }
    .menu-btn { width: 80%; max-width: 300px; padding: 18px; margin: 10px 0; font-size: 18px; font-weight: 500; font-family: 'Prompt', sans-serif; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .menu-btn:active { transform: scale(0.95); }
    .btn-checkin { background: #fff; color: #1e3c72; font-weight: bold; }
    .btn-register { background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.5); }
    #camera-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; z-index: 50; }
    #video-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .top-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 60; }
    .status-text { font-size: 14px; text-shadow: 1px 1px 2px black; }
    .close-btn { background: rgba(0,0,0,0.3); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .bottom-controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 120px; display: flex; justify-content: center; align-items: center; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); z-index: 60; }
    #shutter-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); border: 4px solid white; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; }
    #shutter-btn .inner-circle { width: 65px; height: 65px; background: white; border-radius: 50%; transition: all 0.2s; }
    #shutter-btn:active .inner-circle { width: 55px; height: 55px; background: #ddd; }
    #shutter-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #shutter-btn.reg-mode { border-color: #007bff; }
    #shutter-btn.reg-mode .inner-circle { background: #007bff; }
    #shutter-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 100; }
    .flash-anim { animation: flash 0.2s ease-out; }
    @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }
    #countdown-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 150px; font-weight: bold; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none; z-index: 80; }
  </style>
</head>
<body>

  <div id="home-screen">
    <div class="logo-area">
      <div class="logo-icon">üì∏</div>
      <div class="app-title">Face Check-in</div>
      <div class="app-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
    </div>
    <button class="menu-btn btn-checkin" onclick="openCamera('scan')">
      <span>üïí</span> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    </button>
    <button class="menu-btn btn-register" onclick="openCamera('register')">
      <span>üë§</span> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
    </button>
    <div style="margin-top:30px; font-size: 12px; opacity: 0.5;">v.2.1 Stable Camera</div>
  </div>

  <div id="camera-screen">
    <div class="top-bar">
      <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
      <button class="close-btn" onclick="closeCamera()">‚úï</button>
    </div>
    <div id="video-wrapper">
      <video id="video" autoplay muted playsinline></video>
      <div id="countdown-overlay">3</div>
      <div id="shutter-flash"></div>
    </div>
    <div class="bottom-controls">
      <div id="shutter-btn" onclick="handleShutter()">
        <div class="inner-circle"></div>
      </div>
    </div>
  </div>

  <script>
    // ******************************************************
    // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á APPS SCRIPT ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // ******************************************************
    const GAS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpYV4iyfDavR6S2xrfUfWpQdlao-4GXtMSNRzcrXT69p6rdzP92NWWWMf7oqM2-kx-jw/exec'; 

    let currentMode = 'scan';
    let isCameraRunning = false;
    let detectionInterval;
    let labeledFaceDescriptors = [];
    let currentBestMatch = null;
    let currentStream = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Stream ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó

    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    const homeScreen = document.getElementById('home-screen');
    const cameraScreen = document.getElementById('camera-screen');
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const shutterBtn = document.getElementById('shutter-btn');
    const countdownEl = document.getElementById('countdown-overlay');
    const shutterFlash = document.getElementById('shutter-flash');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- Core Functions ---

    async function openCamera(mode) {
      currentMode = mode;
      homeScreen.style.display = 'none';
      cameraScreen.style.display = 'block';
      
      if (mode === 'register') {
        shutterBtn.classList.add('reg-mode');
        statusEl.innerText = "‡πÇ‡∏´‡∏°‡∏î: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)";
      } else {
        shutterBtn.classList.remove('reg-mode');
        statusEl.innerText = "‡πÇ‡∏´‡∏°‡∏î: ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢)";
      }

      await initCameraSystem();
    }

    function closeCamera() {
      // 1. ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
      stopStream();
      
      // 2. ‡∏´‡∏¢‡∏∏‡∏î Loop AI
      if (detectionInterval) clearInterval(detectionInterval);
      
      // 3. UI Changes
      homeScreen.style.display = 'flex';
      cameraScreen.style.display = 'none';
      isCameraRunning = false;
      
      // 4. ‡∏•‡πâ‡∏≤‡∏á Canvas ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
      const canvas = document.querySelector('canvas');
      if (canvas) canvas.remove();
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (Fix ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á) ---
    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => {
          track.stop(); // ‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡∏•‡∏∞ Track
        });
        currentStream = null;
      }
      if (video.srcObject) {
        video.srcObject = null;
      }
    }

    async function initCameraSystem() {
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
      if(isCameraRunning) return;
      isCameraRunning = true;

      try {
        statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...";
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)
        if (!faceapi.nets.tinyFaceDetector.params) {
             await Promise.all([
              faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
              faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
              faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
        }

        // 2. ‡πÇ‡∏´‡∏•‡∏î Database (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        if (labeledFaceDescriptors.length === 0) {
            const data = await callBackend({ action: 'load_faces' });
            if (data.status === 'success' && data.faces.length > 0) {
                labeledFaceDescriptors = data.faces.map(f => {
                  const descriptorFloat32 = new Float32Array(Object.values(f.descriptor));
                  return new faceapi.LabeledFaceDescriptors(f.label, [descriptorFloat32]);
                });
            }
        }

        // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÅ‡∏ö‡∏ö Safe Mode)
        statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
        await startCameraSafe();

      } catch (err) {
        statusEl.innerText = "Error: " + err.message;
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message + "\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö");
        isCameraRunning = false;
        closeCamera();
      }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (Try -> Catch -> Fallback) ---
    async function startCameraSafe() {
      stopStream(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠

      const constraintsHD = { video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } };
      const constraintsBasic = { video: { facingMode: 'user' } }; // ‡πÅ‡∏ö‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

      try {
        // ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö HD ‡∏Å‡πà‡∏≠‡∏ô
        currentStream = await navigator.mediaDevices.getUserMedia(constraintsHD);
      } catch (e) {
        console.warn("HD failed, trying basic resolution...", e);
        try {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (Fallback)
          currentStream = await navigator.mediaDevices.getUserMedia(constraintsBasic);
        } catch (e2) {
          throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô Browser Settings");
        }
      }

      video.srcObject = currentStream;
      // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Video ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° AI
      video.onloadedmetadata = () => {
        video.play();
      };
    }

    // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    video.addEventListener('play', () => {
      // ‡∏•‡∏ö Canvas ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
      const oldCanvas = document.querySelector('canvas');
      if (oldCanvas) oldCanvas.remove();

      const canvas = faceapi.createCanvasFromMedia(video);
      document.getElementById('video-wrapper').append(canvas);
      
      const displaySize = { width: video.videoWidth, height: video.videoHeight };
      faceapi.matchDimensions(canvas, displaySize);

      statusEl.innerText = currentMode === 'scan' ? "‡∏û‡∏£‡πâ‡∏≠‡∏°! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û" : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Interval ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
      if (detectionInterval) clearInterval(detectionInterval);

      detectionInterval = setInterval(async () => {
        // Safety Check: ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        if (cameraScreen.style.display === 'none') {
            clearInterval(detectionInterval);
            return;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
        if (video.paused || video.ended) return;

        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.4 }))
          .withFaceLandmarks().withFaceDescriptors();
        
        if (detections.length > 0) {
          detections.sort((a, b) => (b.detection.box.width * b.detection.box.height) - (a.detection.box.width * a.detection.box.height));
          const largestFace = detections[0];

          if (labeledFaceDescriptors.length > 0) {
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.45);
            const match = faceMatcher.findBestMatch(largestFace.descriptor);
            
            if (match.label !== 'unknown') {
              currentBestMatch = match;
              if(currentMode === 'scan') statusEl.innerText = "‡∏û‡∏ö: " + match.label;
            } else {
              currentBestMatch = null;
              if(currentMode === 'scan') statusEl.innerText = "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
            }
          }
        } else {
          currentBestMatch = null;
          if(currentMode === 'scan') statusEl.innerText = "‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
        }
      }, 200);
    });

    // --- Shutter & Processing ---
    function handleShutter() {
      if (currentMode === 'scan') {
        startCountdownAndCapture();
      } else {
        registerProcess();
      }
    }

    function startCountdownAndCapture() {
      if (labeledFaceDescriptors.length === 0) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤"); return; }
      
      shutterBtn.style.pointerEvents = 'none'; 
      let count = 3;
      countdownEl.style.display = 'block';
      countdownEl.innerText = count;

      const timer = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.innerText = count;
        } else {
          clearInterval(timer);
          countdownEl.style.display = 'none';
          captureScan(); 
        }
      }, 1000);
    }

    function captureScan() {
      if (!currentBestMatch || currentBestMatch.label === 'unknown') {
        statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)";
        playBeep(); playBeep();
        shutterBtn.style.pointerEvents = 'auto';
        return;
      }

      playBeep();
      triggerFlash();
      statusEl.innerText = "üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + currentBestMatch.label;

      const imageBase64 = getResizedFrame();

      callBackend({
        action: 'save_scan',
        name: currentBestMatch.label,
        image: imageBase64
      }).then(res => {
        statusEl.innerText = "‚úÖ " + res.message;
        setTimeout(() => { statusEl.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠..."; shutterBtn.style.pointerEvents = 'auto'; }, 2000);
      }).catch(err => {
         statusEl.innerText = "‚ùå Error ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
         shutterBtn.style.pointerEvents = 'auto';
      });
    }

    async function registerProcess() {
      const name = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:");
      if (!name) return;

      statusEl.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
      try {
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        
        if (detection) {
          playBeep();
          triggerFlash();
          
          labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
          
          statusEl.innerText = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
          await callBackend({
            action: 'save_face',
            name: name,
            descriptor: Array.from(detection.descriptor)
          });
          
          alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + name);
          statusEl.innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        } else {
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
          statusEl.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
        }
      } catch (e) {
        alert("Error: " + e);
      }
    }

    function triggerFlash() {
      shutterFlash.classList.add('flash-anim');
      setTimeout(() => shutterFlash.classList.remove('flash-anim'), 500);
    }

    function playBeep() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'sine'; osc.frequency.value = 880; gain.gain.value = 0.1;
      osc.start(); setTimeout(() => osc.stop(), 150);
    }

    function getResizedFrame() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth; 
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      
      ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
      const now = new Date();
      const dateText = now.toLocaleDateString('th-TH') + " " + now.toLocaleTimeString('th-TH');
      ctx.font = "20px Prompt"; ctx.fillStyle = "white"; 
      ctx.shadowColor="black"; ctx.shadowBlur=4;
      ctx.fillText(dateText, 10, canvas.height - 20);

      return canvas.toDataURL('image/jpeg', 0.8);
    }

    async function callBackend(payload) {
      const response = await fetch(GAS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      return await response.json();
    }

  </script>
</body>
</html>
