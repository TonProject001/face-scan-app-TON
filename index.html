<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</title>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
  
  <style>
    body { font-family: 'Prompt', sans-serif; text-align: center; background: #f4f6f9; padding: 20px; color: #333; }
    #container { position: relative; display: inline-block; margin-top: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.2); background: #000; }
    video { display: block; object-fit: cover; }
    canvas { position: absolute; top: 0; left: 0; }
    #countdown-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; font-weight: bold; color: white; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); display: none; z-index: 10; pointer-events: none; }
    #status { margin-top: 15px; font-size: 18px; font-weight: 500; min-height: 30px; }
    .btn-group { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
    button { padding: 12px 30px; font-size: 18px; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.15); font-family: 'Prompt', sans-serif; transition: 0.2s;}
    #btn-scan { background: #28a745; color: white; }
    #btn-scan:disabled { background: #ccc; cursor: not-allowed; }
    #btn-reg { background: #007bff; color: white; }
    #btn-reg:disabled { background: #ccc; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
</head>
<body>

  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Connected to Google Sheets)</h2>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API...</div>

  <div id="container">
    <video id="video" width="640" height="480" autoplay muted playsinline></video>
    <div id="countdown-overlay">3</div>
  </div>

  <div class="btn-group">
    <button id="btn-scan" onclick="startCheckInProcess()" disabled>üïí ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
    <button id="btn-reg" onclick="registerFace()" disabled>üë§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <script>
    // ******************************************************
    // ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    // ******************************************************
    const GAS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpYV4iyfDavR6S2xrfUfWpQdlao-4GXtMSNRzcrXT69p6rdzP92NWWWMf7oqM2-kx-jw/exec'; 

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const btnScan = document.getElementById('btn-scan');
    const btnReg = document.getElementById('btn-reg');
    const countdownEl = document.getElementById('countdown-overlay');
    
    let labeledFaceDescriptors = []; 
    let currentBestMatch = null; 

    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    const faceOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.4 });

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.type = 'sine';
      oscillator.frequency.value = 1000; 
      gainNode.gain.value = 0.1;
      oscillator.start();
      setTimeout(() => oscillator.stop(), 200);
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ GAS ‡∏ú‡πà‡∏≤‡∏ô Fetch API ---
    async function callBackend(payload) {
        // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö POST
        const response = await fetch(GAS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        return await response.json();
    }

    async function init() {
        try {
            status.innerText = "‚è≥ 1/3 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI...";
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            
            status.innerText = "‚è≥ 2/3 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≤‡∏Å Cloud...";
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const data = await callBackend({ action: 'load_faces' });
            
            if (data.status === 'success' && data.faces.length > 0) {
                 labeledFaceDescriptors = data.faces.map(f => {
                    const descriptorFloat32 = new Float32Array(Object.values(f.descriptor));
                    return new faceapi.LabeledFaceDescriptors(f.label, [descriptorFloat32]);
                });
            }
            
            status.innerText = "‚è≥ 3/3 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
            startVideo();
        } catch (err) {
            status.innerText = "‚ùå Error: " + err.message;
            status.style.color = "red";
        }
    }

    function startVideo() {
        navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => { video.srcObject = stream; })
            .catch(err => status.innerText = "‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
    }

    video.addEventListener('play', () => {
        const canvas = faceapi.createCanvasFromMedia(video);
        document.getElementById('container').append(canvas);
        const displaySize = { width: video.width, height: video.height };
        faceapi.matchDimensions(canvas, displaySize);
        
        status.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°! (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• " + labeledFaceDescriptors.length + " ‡∏Ñ‡∏ô)";
        btnScan.disabled = false; btnReg.disabled = false;

        setInterval(async () => {
            if (!video.paused && !video.ended) {
                const detections = await faceapi.detectAllFaces(video, faceOptions).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                if (labeledFaceDescriptors.length > 0) {
                    const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.45);
                    currentBestMatch = null; 
                    resizedDetections.forEach(result => {
                        const match = faceMatcher.findBestMatch(result.descriptor);
                        const box = result.detection.box;
                        const drawBox = new faceapi.draw.DrawBox(box, { label: match.toString() });
                        drawBox.draw(canvas);
                        if (match.label !== 'unknown') currentBestMatch = match;
                    });
                }
            }
        }, 100);
    });

    function startCheckInProcess() {
        if (labeledFaceDescriptors.length === 0) { alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤"); return; }
        btnScan.disabled = true; 
        let count = 3; countdownEl.style.display = "block"; countdownEl.innerText = count;
        const timer = setInterval(() => {
            count--;
            if (count > 0) { countdownEl.innerText = count; } else {
                clearInterval(timer); countdownEl.style.display = "none"; captureAndSave();
            }
        }, 1000);
    }

    function captureAndSave() {
        if (!currentBestMatch || currentBestMatch.label === 'unknown') {
            status.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤"; status.style.color = "red";
            playBeep(); playBeep(); btnScan.disabled = false; return;
        }

        status.innerText = "üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Cloud..."; status.style.color = "blue";
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = video.width; tempCanvas.height = video.height;
        const ctx = tempCanvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Watermark
        const now = new Date();
        const dateText = now.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const timeText = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const fullText = `Date: ${dateText} Time: ${timeText} | ID: ${currentBestMatch.label}`;
        ctx.fillStyle = "rgba(0, 0, 0, 0.6)"; ctx.fillRect(0, tempCanvas.height - 40, tempCanvas.width, 40);
        ctx.font = "bold 18px Prompt, Arial"; ctx.fillStyle = "white"; ctx.textAlign = "right";
        ctx.fillText(fullText, tempCanvas.width - 20, tempCanvas.height - 13);

        const imageBase64 = tempCanvas.toDataURL('image/jpeg', 0.8);

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
        callBackend({
            action: 'save_scan',
            name: currentBestMatch.label,
            image: imageBase64
        }).then(res => {
            playBeep();
            status.innerText = "‚úÖ " + res.message; status.style.color = "green";
            setTimeout(() => { status.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô..."; status.style.color = "#333"; btnScan.disabled = false; }, 3000);
        }).catch(err => {
            status.innerText = "‚ùå Error: " + err; btnScan.disabled = false;
        });
    }

    window.registerFace = async function() {
        const name = prompt("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:"); if (!name) return;
        status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
        try {
            const detection = await faceapi.detectSingleFace(video, faceOptions).withFaceLandmarks().withFaceDescriptor();
            if (detection) {
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
                status.innerText = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                
                await callBackend({
                    action: 'save_face',
                    name: name,
                    descriptor: Array.from(detection.descriptor)
                });
                
                status.innerText = "üéâ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                alert("‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            } else { alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤"); }
            status.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...";
        } catch (e) { alert("Error: " + e); }
    };

    init();
  </script>
</body>
</html>
